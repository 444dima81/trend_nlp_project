FROM python:3.11-slim

# Настройки окружения
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    HF_HOME=/app/.cache/hf

WORKDIR /app

# Установка зависимостей ОС для кириллицы и графиков
RUN apt-get update && apt-get install -y --no-install-recommends \
      fontconfig fonts-dejavu-core ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Установка Python-зависимостей
COPY requirements.txt .
RUN python -m pip install -U pip \
 && python -m pip install --no-cache-dir -r requirements.txt \
 && rm -rf /root/.cache/pip

# Копируем код приложения
COPY . .

# Настройки Streamlit
ENV STREAMLIT_SERVER_ADDRESS=0.0.0.0 \
    STREAMLIT_SERVER_PORT=8501 \
    STREAMLIT_SERVER_HEADLESS=true \
    STREAMLIT_SERVER_ENABLECORS=false

EXPOSE 8501

# Запуск через python -m streamlit, чтобы избежать PATH-проблем
CMD ["python", "-m", "streamlit", "run", "main.py"]
